<!DOCTYPE html>
<html>
<!-- [Previous head section remains the same until the end of the style section] -->
<style>
  /* ... [previous styles] ... */
  
  #file-input-container {
    position: fixed;
    top: 10px;
    left: 200px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border: 1px solid #ccc;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
  }

  .file-list {
    margin-top: 10px;
    max-height: 150px;
    overflow-y: auto;
  }

  .file-list div {
    margin: 5px 0;
    font-size: 12px;
  }
</style>
</head>
<body>
  <button id="reset-btn" onclick="resetTrack()">Reset Track</button>

  <div id="file-input-container">
    <input type="file" id="kml-input" multiple accept=".kml" onchange="handleFileSelect(event)">
    <button onclick="loadSelectedFiles()">Felder laden</button>
    <div class="file-list" id="selected-files"></div>
  </div>

  <!-- [Previous legend and task-panel divs remain the same] -->

  <script>
    // [Previous initial variables and map setup remain the same]

    let selectedFiles = [];

    function handleFileSelect(event) {
      selectedFiles = Array.from(event.target.files);
      updateFileList();
    }

    function updateFileList() {
      const fileList = document.getElementById('selected-files');
      fileList.innerHTML = '';
      selectedFiles.forEach(file => {
        const div = document.createElement('div');
        div.textContent = file.name;
        fileList.appendChild(div);
      });
    }

    async function loadSelectedFiles() {
      if (selectedFiles.length === 0) {
        alert('Bitte w채hlen Sie zuerst KML-Dateien aus.');
        return;
      }

      for (const file of selectedFiles) {
        try {
          const kmlText = await file.text();
          const parser = new DOMParser();
          const kml = parser.parseFromString(kmlText, 'text/xml');
          const geojson = toGeoJSON.kml(kml);

          // Extrahiere den Dateinamen ohne .kml Endung als Basis f체r die Field-IDs
          const baseFileName = file.name.replace('.kml', '');

          geojson.features.forEach((feature, index) => {
            // Verwende den Namen aus der KML-Datei oder generiere einen aus Dateiname + Index
            const fieldId = feature.properties.name || `${baseFileName}-${index + 1}`;
            
            // Pr체fe ob das Feld bereits existiert
            if (fields[fieldId]) {
              console.log(`Feld ${fieldId} existiert bereits und wird 체bersprungen`);
              return;
            }

            const field = L.geoJSON(feature, {
              style: {
                color: '#3388ff',
                weight: 2,
                opacity: 0.6,
                fillOpacity: 0.2
              }
            }).addTo(map);

            field.on('click', () => handleFieldClick(fieldId));
            
            fields[fieldId] = {
              layer: field,
              status: 'normal',
              name: fieldId,
              fileName: file.name
            };
          });
        } catch (error) {
          console.error(`Error loading KML file ${file.name}:`, error);
          alert(`Fehler beim Laden von ${file.name}: ${error.message}`);
        }
      }

      // Zoom auf alle geladenen Felder
      const fieldBounds = [];
      Object.values(fields).forEach(field => {
        fieldBounds.push(field.layer.getBounds());
      });
      
      if (fieldBounds.length > 0) {
        const bounds = L.latLngBounds(fieldBounds);
        map.fitBounds(bounds);
      }

      alert(`${Object.keys(fields).length} Felder wurden erfolgreich geladen.`);
    }

    // [Rest of the previous code remains the same]
  </script>
</body>
</html>
